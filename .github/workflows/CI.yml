name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Pull Prokka
        uses: actions/checkout@v5

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: prokka
          environment-file: environment.yml
          miniforge-version: latest
          channels: conda-forge,bioconda
          channel-priority: strict
          auto-update-conda: true

      - name: Add Prokka to PATH
        run: |
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Simple tests
        run: |
          prokka --version
          prokka --help
          ! prokka --doesnotexist
          prokka --depends
          prokka --cleandb
          prokka --setupdb
          prokka --listdb

      - name: Anmotation tests
        run: |
          for F in plasmid genome ; do
            prokka --cpus $(nproc) \
              --outdir $F --prefix $F \
              test/$F.fna
            grep -c '>' $F/$F.fna 
            head -n 1 $F/$F.gbk
            grep '#sequence' $F/$F.gff
          done
